import streamlit as st
import pandas as pd
import folium
from pathlib import Path
import zipfile
import io
from streamlit.components.v1 import html

# ---------------- Page Config ----------------
st.set_page_config(page_title="GPS & Data Visualization Tool", page_icon="üåç", layout="wide")

# ---------------- Custom CSS ----------------
st.markdown("""
    <style>
    /* Title Styling */
    .title {
        text-align: center;
        font-size: 40px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
    }
    .subtitle {
        text-align: center;
        font-size: 18px;
        color: #7f8c8d;
        margin-bottom: 25px;
    }
    /* Footer Styling */
    .footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        padding: 8px;
        font-size: 14px;
        color: white;
        background-color: #2c3e50;
    }
    </style>
""", unsafe_allow_html=True)

# ---------------- App Title ----------------
st.markdown('<div class="title">Flexible GPS & Data Visualization Tool</div>', unsafe_allow_html=True)
st.markdown('<div class="subtitle">Upload your dataset and generate interactive maps instantly üöÄ</div>', unsafe_allow_html=True)

# ---------------- File Upload ----------------
uploaded_file = st.file_uploader("üìÇ Upload Excel or CSV file", type=["xlsx", "csv"])

if uploaded_file:
    with st.spinner("‚è≥ Processing your file... Please wait."):
        # Load data
        if uploaded_file.name.endswith('xlsx'):
            df = pd.read_excel(uploaded_file, dtype=str)
        else:
            df = pd.read_csv(uploaded_file, dtype=str)
        
        st.success("‚úÖ File uploaded successfully!")
        st.write("### üìë Detected columns:", df.columns.tolist())
        
        # Detect latitude and longitude columns (case insensitive)
        lat_col = next((col for col in df.columns if 'latitude' in col.lower()), None)
        lon_col = next((col for col in df.columns if 'longitude' in col.lower()), None)
        
        group_vars = st.multiselect("üîé Select variable(s) for grouping or analysis", options=df.columns.tolist())
        
        visualize_map = False
        if lat_col and lon_col:
            visualize_map = st.checkbox("üó∫Ô∏è Visualize map using GPS coordinates?")
        else:
            st.info("‚ö†Ô∏è GPS coordinates columns not found. Map visualization not available.")
        
        if st.button("‚ú® Generate Visualization"):
            with st.spinner("‚öôÔ∏è Generating visualizations..."):
                if len(group_vars) == 0:
                    st.error("Please select at least one variable for grouping or analysis.")
                else:
                    # If map visualization requested and GPS coordinates are detected
                    if visualize_map and lat_col and lon_col:
                        # Clean coordinates
                        df[lat_col] = pd.to_numeric(df[lat_col], errors='coerce')
                        df[lon_col] = pd.to_numeric(df[lon_col], errors='coerce')
                        df_clean = df.dropna(subset=[lat_col, lon_col])
                        
                        # Use first grouping variable for map creation
                        group_var = group_vars[0]
                        unique_groups = df_clean[group_var].unique()
                        
                        map_files = {}
                        
                        for grp in unique_groups:
                            df_grp = df_clean[df_clean[group_var] == grp]
                            if df_grp.empty:
                                continue
                            center = [df_grp[lat_col].median(), df_grp[lon_col].median()]
                            m = folium.Map(location=center, zoom_start=12)
                            for _, row in df_grp.iterrows():
                                folium.CircleMarker(
                                    location=[row[lat_col], row[lon_col]],
                                    radius=3,
                                    color='blue',
                                    fill=True,
                                    fill_color='blue',
                                    popup=f"{group_var}: {row[group_var]}"
                                ).add_to(m)
                            
                            safe_name = "".join(c if c.isalnum() else "_" for c in str(grp))
                            html_str = m.get_root().render()
                            map_files[f"{safe_name}_map.html"] = html_str
                        
                        # Package maps as ZIP for download
                        zip_buffer = io.BytesIO()
                        with zipfile.ZipFile(zip_buffer, "w") as zf:
                            for fname, html_str in map_files.items():
                                zf.writestr(fname, html_str)
                        zip_buffer.seek(0)
                        
                        st.success(f"üéâ Generated {len(map_files)} map(s) for groups based on '{group_var}'.")
                        st.download_button(
                            "üì• Download All Maps (ZIP)",
                            data=zip_buffer,
                            file_name="generated_maps.zip",
                            mime="application/zip"
                        )
                    else:
                        st.warning("‚ö†Ô∏è Map visualization skipped or unavailable. Showing grouping summary instead.")
                        summary = df[group_vars].drop_duplicates()
                        st.write("### üìä Sample summary (unique combinations):")
                        st.dataframe(summary.head(10))

# ---------------- Footer ----------------
st.markdown('<div class="footer">Created by Milan</div>', unsafe_allow_html=True)
